<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - PitchFrame</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .chat-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 1rem;
            max-width: 70%;
        }

        .message.sent {
            margin-left: auto;
        }

        .message.received {
            margin-right: auto;
        }

        .message-content {
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            position: relative;
        }

        .sent .message-content {
            background: #0d6efd;
            color: white;
            border-bottom-right-radius: 0.25rem;
        }

        .received .message-content {
            background: white;
            border-bottom-left-radius: 0.25rem;
        }

        .message-time {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        .chat-input {
            padding: 1rem;
            background: white;
            border-top: 1px solid #dee2e6;
        }

        .user-info {
            padding: 1rem;
            background: white;
            border-bottom: 1px solid #dee2e6;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .alert {
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem;
            text-align: center;
        }

        .alert a {
            text-decoration: none;
        }

        .spinner-border {
            width: 2rem;
            height: 2rem;
        }

        .text-center {
            text-align: center;
        }

        .my-4 {
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .chat-messages:empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
            font-style: italic;
        }

        .chat-messages:empty::before {
            content: 'No messages yet';
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- User Info -->
        <div class="user-info">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-3">
                    <a href="mentor-matching.html" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <img id="partnerAvatar" src="" alt="" class="user-avatar">
                    <div>
                        <h5 id="partnerName" class="mb-0"></h5>
                        <small id="partnerStatus" class="text-muted"></small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Messages -->
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be dynamically inserted here -->
        </div>

        <!-- Chat Input -->
        <div class="chat-input">
            <form id="messageForm" class="d-flex gap-2">
                <input type="text" id="messageInput" class="form-control" placeholder="Type your message...">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            query, 
            where, 
            orderBy, 
            addDoc, 
            onSnapshot,
            doc,
            getDoc,
            getDocs
        } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        import { firebaseConfig } from './firebase-config.js';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Get room ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('roomId');

        let currentUser = null;

        // Function to format date
        function formatDate(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate();
            return new Intl.DateTimeFormat('en-US', {
                hour: 'numeric',
                minute: 'numeric',
                hour12: true
            }).format(date);
        }

        // Function to load chat messages
        async function loadMessages() {
            try {
                const messagesRef = collection(db, 'messages');
                const q = query(
                    messagesRef,
                    where('roomId', '==', roomId),
                    orderBy('timestamp', 'asc')
                );

                // Show loading state
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>';

                // Real-time listener for messages
                onSnapshot(q, (snapshot) => {
                    chatMessages.innerHTML = ''; // Clear loading state
                    
                    if (snapshot.empty) {
                        chatMessages.innerHTML = `
                            <div class="text-center text-muted my-4">
                                <i class="fas fa-comments fa-2x mb-2"></i>
                                <p>No messages yet. Start the conversation!</p>
                            </div>
                        `;
                        return;
                    }

                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const message = change.doc.data();
                            const messageElement = document.createElement('div');
                            messageElement.className = `message ${message.senderId === currentUser.uid ? 'sent' : 'received'}`;
                            messageElement.innerHTML = `
                                <div class="message-content">
                                    ${message.text}
                                    <div class="message-time">${formatDate(message.timestamp)}</div>
                                </div>
                            `;
                            chatMessages.appendChild(messageElement);
                        }
                    });
                    
                    // Scroll to bottom
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, (error) => {
                    console.error('Error loading messages:', error);
                    if (error.code === 'failed-precondition') {
                        showError(`
                            <p>This chat requires a database index to be created.</p>
                            <p>Please click the link below to create it:</p>
                            <a href="${error.message.split('here: ')[1]}" target="_blank" class="btn btn-primary mt-2">
                                Create Index
                            </a>
                        `);
                    } else {
                        showError('Error loading messages');
                    }
                });

            } catch (error) {
                console.error('Error setting up message listener:', error);
                showError('Error loading messages');
            }
        }

        // Function to load partner info
        async function loadPartnerInfo() {
            try {
                // Get chat room document
                const chatRoomDoc = await getDoc(doc(db, 'chatRooms', roomId));
                
                if (chatRoomDoc.exists()) {
                    const roomData = chatRoomDoc.data();
                    const partnerId = currentUser.uid === roomData.mentorId ? roomData.founderId : roomData.mentorId;
                    
                    // Try to get partner info from mentors collection first
                    let userDoc = await getDoc(doc(db, 'mentors', partnerId));
                    
                    // If not found in mentors, try users collection
                    if (!userDoc.exists()) {
                        userDoc = await getDoc(doc(db, 'users', partnerId));
                    }

                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        document.getElementById('partnerName').textContent = 
                            `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || 'Unknown User';
                        document.getElementById('partnerAvatar').src = userData.profilePicture || 
                            `https://ui-avatars.com/api/?name=${userData.firstName || ''}+${userData.lastName || ''}&background=0D8ABC&color=fff`;
                        document.getElementById('partnerStatus').textContent = 
                            userData.userType === 'mentor' ? 'Mentor' : 'Founder';
                    } else {
                        console.error('Partner user document not found');
                        showError('Could not load partner information');
                    }
                } else {
                    console.error('Chat room not found');
                    showError('Chat room not found');
                }
            } catch (error) {
                console.error('Error loading partner info:', error);
                showError('Error loading chat information');
            }
        }

        // Add error handling helper
        function showError(message) {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="alert alert-danger m-3">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    ${message}
                </div>
            `;
        }

        // Handle message submission
        document.getElementById('messageForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (message) {
                try {
                    await addDoc(collection(db, 'messages'), {
                        roomId: roomId,
                        senderId: currentUser.uid,
                        text: message,
                        timestamp: new Date()
                    });

                    messageInput.value = '';
                } catch (error) {
                    console.error('Error sending message:', error);
                    alert('Error sending message. Please try again.');
                }
            }
        });

        // Initialize chat
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadPartnerInfo();
                await loadMessages();
            } else {
                window.location.href = 'login.html';
            }
        });

        // Add this function where you handle the chat request
        async function createChatNotification(mentorId, founderId, chatRoomId) {
            try {
                await addDoc(collection(db, 'notifications'), {
                    type: 'chat_request',
                    mentorId: mentorId,
                    founderId: founderId,
                    chatRoomId: chatRoomId,
                    read: false,
                    createdAt: new Date()
                });
            } catch (error) {
                console.error('Error creating notification:', error);
            }
        }

        // Call this function when creating a new chat room
        // Add this to your existing chat initialization code where you create the chat room
        await createChatNotification(mentorId, currentUser.uid, roomId);
    </script>
</body>
</html>
